<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Product Upload ‚Äî Supabase</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .preview { margin-top: 15px; padding: 10px; border: 1px solid #ddd; display: flex; gap: 15px; align-items: center; }
    .preview img { max-width: 120px; border: 1px solid #ccc; border-radius: 6px; }
    .log { margin-top: 15px; font-weight: bold; }
    .error { color: red; }
    .success { color: green; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2>Product Upload ‚Äî Supabase</h2>

  <form id="productForm">
    <input type="text" id="productName" placeholder="Product Name" required /><br><br>
    <input type="number" id="productPrice" placeholder="Product Price" required /><br><br>
    <input type="file" id="productImage" accept="image/*" required /><br><br>
    <button type="submit">Upload & Save</button>
  </form>

  <div id="resultArea"></div>
  <div id="message" class="log"></div>

  <script>
    const BUCKET = 'images'; // ‚úÖ Make sure bucket exists & is public

    // üîë Replace with your Supabase credentials
    const supabaseUrl = "https://dklcbcbgpdrqsqupaaeb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrbGNiY2JncGRycXNxdXBhYWViIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzI1ODk1MiwiZXhwIjoyMDcyODM0OTUyfQ.EN8lHW9BBf1qSNXw9fFnFU1rWgIoOsWqltks57qp-pY";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('productForm');
      const msg = document.getElementById('message');
      const resultArea = document.getElementById('resultArea');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.textContent = '';
        resultArea.innerHTML = '';

        const productName = document.getElementById('productName').value.trim();
        const productPrice = document.getElementById('productPrice').value.trim();
        const fileInput = document.getElementById('productImage');
        const file = fileInput.files[0];

        if (!productName || !productPrice || !file) {
          msg.textContent = '‚ùå Please fill all fields!';
          msg.className = 'log error';
          return;
        }

        try {
          const timestamp = Date.now();
          const sanitized = file.name.replace(/\s+/g, '_');
          const pathInBucket = `images/${timestamp}_${sanitized}`;

          msg.textContent = 'Uploading image...';
          const { error: uploadError } = await supabase.storage
            .from(BUCKET)
            .upload(pathInBucket, file, { cacheControl: '3600', upsert: false });

          if (uploadError) {
            console.error('Upload Error:', uploadError);
            msg.textContent = '‚ùå Upload error: ' + uploadError.message;
            msg.className = 'log error';
            return;
          }

          // ‚úÖ Get Public URL
          const { data: urlData, error: urlError } = supabase
            .storage
            .from(BUCKET)
            .getPublicUrl(pathInBucket);

          if (urlError) {
            console.error('URL Error:', urlError);
            msg.textContent = '‚ùå Error getting image URL';
            msg.className = 'log error';
            return;
          }

          const publicUrl = urlData.publicUrl;
          console.log("Public Image URL:", publicUrl);

          msg.textContent = 'Saving product to database...';
          const { data, error } = await supabase
            .from('Products')
            .insert([
              {
                productname: productName,
                productprice: productPrice,
                productimage: publicUrl
              }
            ]);

          if (error) {
            console.error('Insert error:', error);
            msg.textContent = '‚ùå DB insert error: ' + error.message;
            msg.className = 'log error';
            return;
          }

          msg.textContent = '‚úÖ Product saved successfully!';
          msg.className = 'log success';

          // ‚úÖ Show preview
          const container = document.createElement('div');
          container.className = 'preview';

          const img = document.createElement('img');
          img.src = publicUrl;
          img.alt = productName;

          const info = document.createElement('div');
          info.innerHTML = `<strong>${escapeHtml(productName)}</strong><br>
                            üí∞ Price: ${escapeHtml(productPrice)}<br>
                            <small>Stored in bucket: ${escapeHtml(BUCKET)}</small>`;

          container.appendChild(img);
          container.appendChild(info);
          resultArea.appendChild(container);

          form.reset();
        } catch (err) {
          console.error('Unexpected error:', err);
          msg.textContent = '‚ùå Something went wrong: ' + (err.message || err);
          msg.className = 'log error';
        }
      });
    });

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }
  </script>
</body>
</html>
