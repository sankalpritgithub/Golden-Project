<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Upload ‚Äî Supabase</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { margin-bottom: 20px; }
    input, button { margin: 5px 0; padding: 8px; }
    .log { margin-top: 10px; color: darkblue; }
    .preview { margin-top: 20px; }
    .preview img { max-width: 200px; display: block; margin-bottom: 10px; }
  </style>
</head>
<body>

  <h2>Product Upload ‚Äî Supabase</h2>

  <form id="productForm">
    <input type="text" id="productName" placeholder="Product Name" required />
    <input type="file" id="productImage" accept="image/*" required />
    <button type="submit">Upload & Save</button>
  </form>

  <div id="resultArea"></div>
  <div id="message" class="log"></div>

  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // üîπ Apna Supabase Project URL aur anon key yahan daalo
    const SUPABASE_URL = "https://dklcbcbgpdrqsqupaaeb.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrbGNiY2JncGRycXNxdXBhYWViIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzI1ODk1MiwiZXhwIjoyMDcyODM0OTUyfQ.EN8lHW9BBf1qSNXw9fFnFU1rWgIoOsWqltks57qp-pY"

    // ‚úÖ Initialize supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
   const BUCKET = 'product_images'


    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('productForm')
      const msg = document.getElementById('message')
      const resultArea = document.getElementById('resultArea')

      form.addEventListener('submit', async (e) => {
        e.preventDefault()
        msg.textContent = ''
        resultArea.innerHTML = ''

        const productName = document.getElementById('productName').value.trim()
        const fileInput = document.getElementById('productImage')
        const file = fileInput.files && fileInput.files[0]

        if (!productName) {
          msg.textContent = '‚ö†Ô∏è Product name daalo.'
          return
        }
        if (!file) {
          msg.textContent = '‚ö†Ô∏è Image select karo.'
          return
        }

        try {
          const timestamp = Date.now()
          const sanitized = file.name.replace(/\s+/g, '_')
          const pathInBucket = `images/${timestamp}_${sanitized}`

          msg.textContent = '‚è≥ Uploading image...'
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from(BUCKET)
            .upload(pathInBucket, file, { cacheControl: '3600', upsert: false })

          if (uploadError) {
            msg.textContent = '‚ùå Upload error: ' + uploadError.message
            return
          }

          // Get Public URL
          const { data: urlData } = supabase.storage.from(BUCKET).getPublicUrl(pathInBucket)
          const publicUrl = urlData.publicUrl

          msg.textContent = '‚è≥ Saving product to database...'
          const { data, error } = await supabase
            .from('Products')   // üîπ Table ka naam check kar lo (case-sensitive hota hai)
            .insert([
              { productname: productName, productimage: publicUrl }
            ])

          if (error) {
            msg.textContent = '‚ùå DB insert error: ' + error.message
            return
          }

          msg.textContent = '‚úÖ Product saved successfully!'
          const container = document.createElement('div')
          container.className = 'preview'

          const img = document.createElement('img')
          img.src = publicUrl
          img.alt = productName

          const info = document.createElement('div')
          info.innerHTML = `<strong>${escapeHtml(productName)}</strong><br>
                            <small>Stored in bucket: ${escapeHtml(BUCKET)}<br>
                            Public URL stored in database</small>`

          container.appendChild(img)
          container.appendChild(info)
          resultArea.appendChild(container)

          form.reset()
        } catch (err) {
          msg.textContent = '‚ùå Unexpected error: ' + err.message
        }
      })
    })

    // simple escape
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]
      })
    }
  </script>
</body>
</html>
